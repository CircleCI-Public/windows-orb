version: 2.1

description: "A set of tools convenient for running Windows jobs on CircleCI."

executors:
  preview-default:
    description: >
      An executor for the pre-release preview period.
      This syntax is subject to change before general release of Windows.
    parameters:
      image:
        type: enum
        description: The image to use when executing. Defaults to "windows-server-2019"
        enum: ["windows-server-2019"]
        default: "windows-server-2019"
      # TODO: this should maybe get sugared?
      shell:
        type: string
        description: >
          The shell to use.
          Defaults to `powershell.exe -NoProfile -ExecutionPolicy Bypass`
        default: powershell.exe -NoProfile -ExecutionPolicy Bypass
    machine:
      image: windows-server-2019
      resource_class: windows.medium
      shell: << parameters.shell >>

commands:
  windows-defender-status:
    description: >
      Prints out the current status of windows defender including any
      excluded paths, extensions, and processes.
    steps:
      - run:
          name: Windows Defender Status
          command: |
            Get-MpPreference | `
            Select DisableRealtimeMonitoring, ExclusionExtension, ExclusionProcess, ExclusionPath | `
            Format-List

  add-windows-defender-exclusions:
    description: >
      Adds any process, path, or extension based exclusions to the exclusion lists.
    parameters:
      exclusion-processes:
        description: >
          A comma separated list of processes, as paths to process images. This
          excludes any files opened by the processes that you specify from
          scheduled and real-time scanning. Specifying this excludes files opened by
          executable programs only. The does not exclude the processes themselves. To
          exclude a process, specify it by using the exclusion-paths parameter.
        type: string
        default: ""
      exclusion-paths:
        description: >
          A comma separated list of file paths to exclude from scheduled and real-time
          scanning. You can specify a folder to exclude all the files under the folder.
        type: string
        default: ""
      exclusion-extensions:
        description: >
          A comma separated list of file name extensions without the leading
          ".", such as obj or lib, to exclude from scheduled, custom, and real-time
          scanning.
        type: string
        default: ""
    steps:
      - run:
          name: Enable Windows Defender
          command: |

            if ("<< parameters.exclusion-processes >>") {
              Write-Host "Adding process exclusions: << parameters.exclusion-processes >>"
              Set-MpPreference `
                -ExclusionName "<< parameters.exclusion-processes >>".Split(",")
            }

            if ("<< parameters.exclusion-paths >>") {
              Write-Host "Adding path exclusions: << parameters.exclusion-paths >>"
              Set-MpPreference `
                -ExclusionPath "<< parameters.exclusion-paths >>".Split(",")
            }

            if ("<< parameters.exclusion-extensions >>") {
              Write-Host "Adding extension exclusions: << parameters.exclusion-extensions >>"
              Set-MpPreference `
                -ExclusionExtension "<< parameters.exclusion-extensions >>".Split(",")
            }

  remove-windows-defender-exclusions:
    description: >
      Removes any process, path, or extension based exclusions from the exclusion lists.
    parameters:
      exclusion-processes:
        description: >
          A comma separated list of processes to remove from the exclusion list.
        type: string
        default: ""
      exclusion-paths:
        description: >
          A comma separated list of paths to remove from the exclusion list.
        type: string
        default: ""
      exclusion-extensions:
        description: >
          A comma separated list of extensions to remove from the exclusion list.
        type: string
        default: ""
    steps:
      - run:
          name: Enable Windows Defender
          command: |
            if ("<< parameters.exclusion-processes >>") {
              Write-Host "Removing process exclusions: << parameters.exclusion-processes >>"
              Remove-MpPreference `
                -ExclusionName "<< parameters.exclusion-processes >>".Split(",")
            }

            if ("<< parameters.exclusion-paths >>") {
              Write-Host "Removing path exclusions: << parameters.exclusion-paths >>"
              Remove-MpPreference `
                -ExclusionPath "<< parameters.exclusion-paths >>".Split(",")
            }

            if ("<< parameters.exclusion-extensions >>") {
              Write-Host "Removing extension exclusions: << parameters.exclusion-extensions >>"
              Remove-MpPreference `
                -ExclusionExtension "<< parameters.exclusion-extensions >>".Split(",")
            }

  enable-windows-defender:
    description: |
      Turns window defender on at the cost of IO performance.
    steps:
      - run:
          name: Enable Windows Defender
          command: |
            Set-MpPreference -DisableRealtimeMonitoring $false

  disable-windows-defender:
    description: |
      Turns window defender off for improved IO performance.
    steps:
      - run:
          name: Disable Windows Defender
          command: |
            Set-MpPreference -DisableRealtimeMonitoring $true
